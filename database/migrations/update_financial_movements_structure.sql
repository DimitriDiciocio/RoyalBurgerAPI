-- =====================================================
-- MIGRAÇÃO: Atualização da estrutura de FINANCIAL_MOVEMENTS
-- Data: 25/11/2025
-- Descrição: Renomeia colunas TYPE para MOVEMENT_TYPE e VALUE para FINANCIAL_VALUE
--            Atualiza DESCRIPTION para VARCHAR(512) e NOTES para VARCHAR(512)
-- =====================================================

-- ATENÇÃO: Esta migração requer que não haja transações ativas na tabela
-- Execute em um momento de baixo uso do sistema

-- Passo 1: Criar nova tabela com a estrutura atualizada
CREATE TABLE FINANCIAL_MOVEMENTS_NEW (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    MOVEMENT_TYPE VARCHAR(20) NOT NULL,
    FINANCIAL_VALUE DECIMAL(12,2) NOT NULL,
    CATEGORY VARCHAR(100) NOT NULL,
    SUBCATEGORY VARCHAR(100),
    DESCRIPTION VARCHAR(512) NOT NULL,
    MOVEMENT_DATE TIMESTAMP,
    PAYMENT_STATUS VARCHAR(20) DEFAULT 'Pending' NOT NULL,
    PAYMENT_METHOD VARCHAR(50),
    SENDER_RECEIVER VARCHAR(255),
    RELATED_ENTITY_TYPE VARCHAR(50),
    RELATED_ENTITY_ID INTEGER,
    NOTES VARCHAR(512),
    PAYMENT_GATEWAY_ID VARCHAR(100),
    TRANSACTION_ID VARCHAR(100),
    BANK_ACCOUNT VARCHAR(50),
    RECONCILED BOOLEAN DEFAULT FALSE,
    RECONCILED_AT TIMESTAMP,
    CREATED_BY INTEGER,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PK_FINANCIAL_MOVEMENTS_NEW PRIMARY KEY (ID),
    CONSTRAINT FK_FINANCIAL_MOVEMENTS_NEW_USER FOREIGN KEY (CREATED_BY) REFERENCES USERS(ID)
);

-- Passo 2: Copiar dados da tabela antiga para a nova
-- IMPORTANTE: NOTES é BLOB na tabela antiga, vamos converter para VARCHAR
INSERT INTO FINANCIAL_MOVEMENTS_NEW (
    ID, MOVEMENT_TYPE, FINANCIAL_VALUE, CATEGORY, SUBCATEGORY, DESCRIPTION,
    MOVEMENT_DATE, PAYMENT_STATUS, PAYMENT_METHOD, SENDER_RECEIVER,
    RELATED_ENTITY_TYPE, RELATED_ENTITY_ID, NOTES,
    PAYMENT_GATEWAY_ID, TRANSACTION_ID, BANK_ACCOUNT,
    RECONCILED, RECONCILED_AT, CREATED_BY, CREATED_AT, UPDATED_AT
)
SELECT 
    ID, 
    TYPE, 
    "VALUE", 
    CATEGORY, 
    SUBCATEGORY, 
    DESCRIPTION,
    MOVEMENT_DATE, 
    PAYMENT_STATUS, 
    PAYMENT_METHOD, 
    SENDER_RECEIVER,
    RELATED_ENTITY_TYPE, 
    RELATED_ENTITY_ID, 
    CAST(COALESCE(NOTES, '') AS VARCHAR(512)),
    PAYMENT_GATEWAY_ID, 
    TRANSACTION_ID, 
    BANK_ACCOUNT,
    RECONCILED, 
    RECONCILED_AT, 
    CREATED_BY, 
    CREATED_AT, 
    UPDATED_AT
FROM FINANCIAL_MOVEMENTS;

-- Passo 3: Dropar constraints e índices da tabela antiga
DROP INDEX IDX_FINANCIAL_MOVEMENTS_TYPE;
DROP INDEX IDX_FINANCIAL_MOVEMENTS_STATUS;
DROP INDEX IDX_FINANCIAL_MOVEMENTS_MOVEMENT_DATE;
DROP INDEX IDX_FINANCIAL_MOVEMENTS_CATEGORY;
DROP INDEX IDX_FINANCIAL_MOVEMENTS_RELATED;
DROP INDEX IDX_FINANCIAL_MOVEMENTS_CREATED_AT;
DROP INDEX FK_FINANCIAL_MOVEMENTS_USER;
DROP INDEX IDX_FINANCIAL_MOVEMENTS_GATEWAY;
DROP INDEX IDX_FINANCIAL_MOVEMENTS_TRANSACTION;
DROP INDEX IDX_FINANCIAL_MOVEMENTS_RECONCILED;

-- Passo 4: Dropar tabela antiga
DROP TABLE FINANCIAL_MOVEMENTS;

-- Passo 5: Renomear tabela nova para o nome original
-- NOTA: Firebird não suporta ALTER TABLE RENAME diretamente em versões antigas
-- Se o comando abaixo falhar, use a sintaxe específica da sua versão do Firebird
-- ou mantenha o nome FINANCIAL_MOVEMENTS_NEW e atualize todas as referências no código

-- Para Firebird 3.0+:
ALTER TABLE FINANCIAL_MOVEMENTS_NEW RENAME TO FINANCIAL_MOVEMENTS;

-- Passo 6: Criar índices na tabela renomeada
CREATE INDEX IDX_FIN_MOV_USER ON FINANCIAL_MOVEMENTS (CREATED_BY);
CREATE INDEX IDX_FIN_MOV_CATEGORY ON FINANCIAL_MOVEMENTS (CATEGORY);
CREATE INDEX IDX_FIN_MOV_CREATED_AT ON FINANCIAL_MOVEMENTS (CREATED_AT);
CREATE INDEX IDX_FIN_MOV_GATEWAY ON FINANCIAL_MOVEMENTS (PAYMENT_GATEWAY_ID);
CREATE INDEX IDX_FIN_MOV_MOVEMENT_DATE ON FINANCIAL_MOVEMENTS (MOVEMENT_DATE);
CREATE INDEX IDX_FIN_MOV_RECONCILED ON FINANCIAL_MOVEMENTS (RECONCILED);
CREATE INDEX IDX_FIN_MOV_RELATED ON FINANCIAL_MOVEMENTS (RELATED_ENTITY_TYPE, RELATED_ENTITY_ID);
CREATE INDEX IDX_FIN_MOV_STATUS ON FINANCIAL_MOVEMENTS (PAYMENT_STATUS);
CREATE INDEX IDX_FIN_MOV_TRANSACTION ON FINANCIAL_MOVEMENTS (TRANSACTION_ID);
CREATE INDEX IDX_FIN_MOV_TYPE ON FINANCIAL_MOVEMENTS (MOVEMENT_TYPE);

-- Passo 7: Resetar o generator/sequence do ID para o próximo valor correto
-- Execute este comando substituindo XXXXX pelo próximo ID disponível
-- SELECT MAX(ID) + 1 FROM FINANCIAL_MOVEMENTS;
-- ALTER SEQUENCE GEN_FINANCIAL_MOVEMENTS RESTART WITH XXXXX;

COMMIT;

-- =====================================================
-- VERIFICAÇÃO PÓS-MIGRAÇÃO
-- =====================================================

-- Verificar contagem de registros
-- SELECT COUNT(*) FROM FINANCIAL_MOVEMENTS;

-- Verificar estrutura da tabela
-- SELECT RDB$FIELD_NAME, RDB$FIELD_TYPE 
-- FROM RDB$RELATION_FIELDS 
-- WHERE RDB$RELATION_NAME = 'FINANCIAL_MOVEMENTS';

-- Verificar índices criados
-- SELECT RDB$INDEX_NAME 
-- FROM RDB$INDICES 
-- WHERE RDB$RELATION_NAME = 'FINANCIAL_MOVEMENTS';

-- =====================================================
-- ROLLBACK (EM CASO DE ERRO)
-- =====================================================

-- Se algo der errado durante a migração, execute:
-- ROLLBACK;
-- E investigue o erro antes de tentar novamente

