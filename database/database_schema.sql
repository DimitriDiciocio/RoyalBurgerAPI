-- =====================================================
-- ROYAL BURGER DATABASE SCHEMA
-- Estrutura atual do banco de dados Firebird
-- =====================================================

-- ADDRESSES definition
-- Drop table
-- DROP TABLE ADDRESSES;

CREATE TABLE ADDRESSES (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	USER_ID INTEGER NOT NULL,
	STREET VARCHAR(255) NOT NULL,
	"NUMBER" VARCHAR(20),
	COMPLEMENT VARCHAR(100),
	NEIGHBORHOOD VARCHAR(100) NOT NULL,
	CITY VARCHAR(100) NOT NULL,
	STATE VARCHAR(2) NOT NULL,
	ZIP_CODE VARCHAR(10) NOT NULL,
	IS_ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	IS_DEFAULT BOOLEAN DEFAULT FALSE NOT NULL,
	CONSTRAINT INTEG_16 PRIMARY KEY (ID),
	CONSTRAINT INTEG_18 FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);
CREATE INDEX RDB$FOREIGN8 ON ADDRESSES (USER_ID);
CREATE UNIQUE INDEX RDB$PRIMARY7 ON ADDRESSES (ID);

-- APP_SETTINGS definition
-- Drop table
-- DROP TABLE APP_SETTINGS;

CREATE TABLE APP_SETTINGS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	-- Metas Financeiras
	META_RECEITA_MENSAL DECIMAL(12,2),
	META_PEDIDOS_MENSAIS INTEGER,
	-- Prazos (em minutos)
	PRAZO_INICIACAO INTEGER,
	PRAZO_PREPARO INTEGER,
	PRAZO_ENVIO INTEGER,
	PRAZO_ENTREGA INTEGER,
	-- Taxas
	TAXA_ENTREGA DECIMAL(10,2),
	TAXA_CONVERSAO_GANHO_CLUBE DECIMAL(5,2),
	TAXA_CONVERSAO_RESGATE_CLUBE DECIMAL(5,2),
	TAXA_EXPIRACAO_PONTOS_CLUBE INTEGER,
	-- Taxas de métodos de pagamento (Fase 3 - Ajustes Lógicos)
	TAXA_CARTAO_CREDITO DECIMAL(5,2) DEFAULT 2.5,
	TAXA_CARTAO_DEBITO DECIMAL(5,2) DEFAULT 1.5,
	TAXA_PIX DECIMAL(5,2) DEFAULT 0.0,
	TAXA_IFOOD DECIMAL(5,2) DEFAULT 15.0,
	TAXA_UBER_EATS DECIMAL(5,2) DEFAULT 30.0,
	-- Informações da Empresa
	NOME_FANTASIA VARCHAR(255),
	RAZAO_SOCIAL VARCHAR(255),
	CNPJ VARCHAR(18),
	ENDERECO VARCHAR(512),
	TELEFONE VARCHAR(20),
	EMAIL VARCHAR(100),
	-- Auditoria
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	UPDATED_BY INTEGER,
	CONSTRAINT INTEG_111 PRIMARY KEY (ID),
	CONSTRAINT INTEG_112 FOREIGN KEY (UPDATED_BY) REFERENCES USERS(ID)
);
CREATE INDEX RDB$FOREIGN48 ON APP_SETTINGS (UPDATED_BY);
CREATE INDEX IDX_APP_SETTINGS_UPDATED_AT ON APP_SETTINGS (UPDATED_AT DESC);
CREATE UNIQUE INDEX RDB$PRIMARY47 ON APP_SETTINGS (ID);

-- CART_ITEM_EXTRAS definition
-- Drop table
-- DROP TABLE CART_ITEM_EXTRAS;

CREATE TABLE CART_ITEM_EXTRAS (
	ID INTEGER NOT NULL,
	CART_ITEM_ID INTEGER NOT NULL,
	INGREDIENT_ID INTEGER NOT NULL,
    QUANTITY INTEGER DEFAULT 1 NOT NULL,
    TYPE VARCHAR(10) DEFAULT 'extra' NOT NULL,
    DELTA INTEGER DEFAULT 1 NOT NULL,
    UNIT_PRICE DECIMAL(10,2) DEFAULT 0 NOT NULL,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	CONSTRAINT PK_CART_ITEM_EXTRAS PRIMARY KEY (ID),
	CONSTRAINT FK_CART_ITEM_EXTRAS_INGREDIENT FOREIGN KEY (INGREDIENT_ID) REFERENCES INGREDIENTS(ID),
	CONSTRAINT FK_CART_ITEM_EXTRAS_ITEM FOREIGN KEY (CART_ITEM_ID) REFERENCES CART_ITEMS(ID) ON DELETE CASCADE
);
CREATE INDEX FK_CART_ITEM_EXTRAS_INGREDIENT ON CART_ITEM_EXTRAS (INGREDIENT_ID);
CREATE INDEX FK_CART_ITEM_EXTRAS_ITEM ON CART_ITEM_EXTRAS (CART_ITEM_ID);
CREATE INDEX IDX_CART_ITEM_EXTRAS_INGREDIENT_ID ON CART_ITEM_EXTRAS (INGREDIENT_ID);
CREATE INDEX IDX_CART_ITEM_EXTRAS_ITEM_ID ON CART_ITEM_EXTRAS (CART_ITEM_ID);
CREATE UNIQUE INDEX UQ_CART_ITEM_ING_TYPE ON CART_ITEM_EXTRAS (CART_ITEM_ID, INGREDIENT_ID, TYPE);

-- CART_ITEMS definition
-- Drop table
-- DROP TABLE CART_ITEMS;

CREATE TABLE CART_ITEMS (
	ID INTEGER NOT NULL,
	CART_ID INTEGER NOT NULL,
	PRODUCT_ID INTEGER NOT NULL,
	QUANTITY INTEGER DEFAULT 1 NOT NULL,
	NOTES BLOB SUB_TYPE TEXT,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	CONSTRAINT PK_CART_ITEMS PRIMARY KEY (ID),
	CONSTRAINT FK_CART_ITEMS_CART FOREIGN KEY (CART_ID) REFERENCES CARTS(ID) ON DELETE CASCADE,
	CONSTRAINT FK_CART_ITEMS_PRODUCT FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCTS(ID)
);
CREATE INDEX FK_CART_ITEMS_CART ON CART_ITEMS (CART_ID);
CREATE INDEX FK_CART_ITEMS_PRODUCT ON CART_ITEMS (PRODUCT_ID);
CREATE INDEX IDX_CART_ITEMS_CART_ID ON CART_ITEMS (CART_ID);
CREATE INDEX IDX_CART_ITEMS_PRODUCT_ID ON CART_ITEMS (PRODUCT_ID);

-- CARTS definition
-- Drop table
-- DROP TABLE CARTS;

CREATE TABLE CARTS (
	ID INTEGER NOT NULL,
	USER_ID INTEGER,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	IS_ACTIVE BOOLEAN DEFAULT TRUE,
	CONSTRAINT PK_CARTS PRIMARY KEY (ID),
	CONSTRAINT UK_CARTS_USER_ACTIVE UNIQUE (USER_ID,IS_ACTIVE),
	CONSTRAINT FK_CARTS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID)
);
CREATE INDEX FK_CARTS_USER ON CARTS (USER_ID);
CREATE INDEX IDX_CARTS_ACTIVE ON CARTS (IS_ACTIVE);
CREATE INDEX IDX_CARTS_USER_ID ON CARTS (USER_ID);

-- CATEGORIES definition
-- Drop table
-- DROP TABLE CATEGORIES;

CREATE TABLE CATEGORIES (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	DESCRIPTION BLOB SUB_TYPE TEXT,
	IS_ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	DISPLAY_ORDER INTEGER DEFAULT 0,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	CONSTRAINT PK_CATEGORIES PRIMARY KEY (ID)
);
CREATE INDEX IDX_CATEGORIES_DISPLAY_ORDER ON CATEGORIES (DISPLAY_ORDER);

-- CHAT_MESSAGES definition
-- Drop table
-- DROP TABLE CHAT_MESSAGES;

CREATE TABLE CHAT_MESSAGES (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	CHAT_ID INTEGER NOT NULL,
	SENDER_ID INTEGER NOT NULL,
	MESSAGE BLOB SUB_TYPE TEXT NOT NULL,
	TIMESTAMP_ TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	IS_READ BOOLEAN DEFAULT FALSE,
	CONSTRAINT INTEG_94 PRIMARY KEY (ID),
	CONSTRAINT INTEG_96 FOREIGN KEY (CHAT_ID) REFERENCES CHATS(ID) ON DELETE CASCADE,
	CONSTRAINT INTEG_98 FOREIGN KEY (SENDER_ID) REFERENCES USERS(ID)
);
CREATE INDEX RDB$FOREIGN42 ON CHAT_MESSAGES (CHAT_ID);
CREATE INDEX RDB$FOREIGN43 ON CHAT_MESSAGES (SENDER_ID);
CREATE UNIQUE INDEX RDB$PRIMARY41 ON CHAT_MESSAGES (ID);

-- CHATS definition
-- Drop table
-- DROP TABLE CHATS;

CREATE TABLE CHATS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	ORDER_ID INTEGER NOT NULL,
	USER_ID INTEGER NOT NULL,
	ATTENDANT_ID INTEGER,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	IS_OPEN BOOLEAN DEFAULT TRUE,
	CONSTRAINT INTEG_86 PRIMARY KEY (ID),
	CONSTRAINT INTEG_88 UNIQUE (ORDER_ID),
	CONSTRAINT INTEG_89 FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ID) ON DELETE CASCADE,
	CONSTRAINT INTEG_91 FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
	CONSTRAINT INTEG_92 FOREIGN KEY (ATTENDANT_ID) REFERENCES USERS(ID)
);
CREATE UNIQUE INDEX "RDB$37" ON CHATS (ORDER_ID);
CREATE INDEX RDB$FOREIGN38 ON CHATS (ORDER_ID);
CREATE INDEX RDB$FOREIGN39 ON CHATS (USER_ID);
CREATE INDEX RDB$FOREIGN40 ON CHATS (ATTENDANT_ID);
CREATE UNIQUE INDEX RDB$PRIMARY36 ON CHATS (ID);

-- EMAIL_VERIFICATIONS definition
-- Drop table
-- DROP TABLE EMAIL_VERIFICATIONS;

CREATE TABLE EMAIL_VERIFICATIONS (
	ID INTEGER NOT NULL,
	EMAIL VARCHAR(255) NOT NULL,
	VERIFICATION_CODE VARCHAR(6) NOT NULL,
	EXPIRES_AT TIMESTAMP NOT NULL,
	CREATED_AT TIMESTAMP NOT NULL,
	CONSTRAINT INTEG_126 PRIMARY KEY (ID)
);
CREATE INDEX IDX_EMAIL_VERIFICATIONS_EMAIL ON EMAIL_VERIFICATIONS (EMAIL);
CREATE INDEX IDX_EMAIL_VERIFICATIONS_EXPIRES ON EMAIL_VERIFICATIONS (EXPIRES_AT);
CREATE UNIQUE INDEX RDB$PRIMARY51 ON EMAIL_VERIFICATIONS (ID);

-- FINANCIAL_TRANSACTIONS definition
-- Drop table
-- DROP TABLE FINANCIAL_TRANSACTIONS;
-- NOTA: Tabela mantida para histórico. Novas movimentações devem usar FINANCIAL_MOVEMENTS

CREATE TABLE FINANCIAL_TRANSACTIONS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	DESCRIPTION VARCHAR(255) NOT NULL,
	AMOUNT DECIMAL(10,2) NOT NULL,
	"TYPE" VARCHAR(20) NOT NULL,
	TRANSACTION_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	PAYMENT_METHOD VARCHAR(50),
	NOTES BLOB SUB_TYPE TEXT,
	CREATED_BY INTEGER,
	CONSTRAINT INTEG_118 PRIMARY KEY (ID),
	CONSTRAINT INTEG_124 FOREIGN KEY (CREATED_BY) REFERENCES USERS(ID)
);
CREATE INDEX RDB$FOREIGN50 ON FINANCIAL_TRANSACTIONS (CREATED_BY);
CREATE UNIQUE INDEX RDB$PRIMARY49 ON FINANCIAL_TRANSACTIONS (ID);

-- FINANCIAL_MOVEMENTS definition
-- Drop table
-- DROP TABLE FINANCIAL_MOVEMENTS;
-- NOVA TABELA: Sistema de Fluxo de Caixa Remodelado

CREATE TABLE FINANCIAL_MOVEMENTS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	MOVEMENT_TYPE VARCHAR(20) NOT NULL,
	FINANCIAL_VALUE DECIMAL(12,2) NOT NULL,
	CATEGORY VARCHAR(100) NOT NULL,
	SUBCATEGORY VARCHAR(100),
	DESCRIPTION VARCHAR(512) NOT NULL,
	MOVEMENT_DATE TIMESTAMP,
	PAYMENT_STATUS VARCHAR(20) DEFAULT 'Pending' NOT NULL,
	PAYMENT_METHOD VARCHAR(50),
	SENDER_RECEIVER VARCHAR(255),
	RELATED_ENTITY_TYPE VARCHAR(50),
	RELATED_ENTITY_ID INTEGER,
	NOTES VARCHAR(512),
	-- Campos para integração com gateways de pagamento e conciliação bancária
	PAYMENT_GATEWAY_ID VARCHAR(100),
	TRANSACTION_ID VARCHAR(100),
	BANK_ACCOUNT VARCHAR(50),
	RECONCILED BOOLEAN DEFAULT FALSE,
	RECONCILED_AT TIMESTAMP,
	CREATED_BY INTEGER,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	CONSTRAINT PK_FINANCIAL_MOVEMENTS PRIMARY KEY (ID),
	CONSTRAINT FK_FINANCIAL_MOVEMENTS_USER FOREIGN KEY (CREATED_BY) REFERENCES USERS(ID)
);
CREATE INDEX IDX_FIN_MOV_USER ON FINANCIAL_MOVEMENTS (CREATED_BY);
CREATE INDEX IDX_FIN_MOV_CATEGORY ON FINANCIAL_MOVEMENTS (CATEGORY);
CREATE INDEX IDX_FIN_MOV_CREATED_AT ON FINANCIAL_MOVEMENTS (CREATED_AT);
CREATE INDEX IDX_FIN_MOV_GATEWAY ON FINANCIAL_MOVEMENTS (PAYMENT_GATEWAY_ID);
CREATE INDEX IDX_FIN_MOV_MOVEMENT_DATE ON FINANCIAL_MOVEMENTS (MOVEMENT_DATE);
CREATE INDEX IDX_FIN_MOV_RECONCILED ON FINANCIAL_MOVEMENTS (RECONCILED);
CREATE INDEX IDX_FIN_MOV_RELATED ON FINANCIAL_MOVEMENTS (RELATED_ENTITY_TYPE, RELATED_ENTITY_ID);
CREATE INDEX IDX_FIN_MOV_STATUS ON FINANCIAL_MOVEMENTS (PAYMENT_STATUS);
CREATE INDEX IDX_FIN_MOV_TRANSACTION ON FINANCIAL_MOVEMENTS (TRANSACTION_ID);
CREATE INDEX IDX_FIN_MOV_TYPE ON FINANCIAL_MOVEMENTS (MOVEMENT_TYPE);

-- RECURRING_TAXES definition
-- Drop table
-- DROP TABLE RECURRING_TAXES;
-- NOVA TABELA: Gestão de Impostos Recorrentes

CREATE TABLE RECURRING_TAXES (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	DESCRIPTION VARCHAR(255),
	CATEGORY VARCHAR(100) NOT NULL,
	SUBCATEGORY VARCHAR(100),
	"VALUE" DECIMAL(12,2) NOT NULL,
	PAYMENT_DAY INTEGER NOT NULL,
	IS_ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	SENDER_RECEIVER VARCHAR(255),
	NOTES BLOB SUB_TYPE TEXT,
	CREATED_BY INTEGER,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	CONSTRAINT PK_RECURRING_TAXES PRIMARY KEY (ID),
	CONSTRAINT FK_RECURRING_TAXES_USER FOREIGN KEY (CREATED_BY) REFERENCES USERS(ID),
	CONSTRAINT CHK_RECURRING_TAXES_DAY CHECK (PAYMENT_DAY >= 1 AND PAYMENT_DAY <= 31),
	CONSTRAINT CHK_RECURRING_TAXES_VALUE CHECK ("VALUE" > 0)
);
CREATE INDEX IDX_RECURRING_TAXES_ACTIVE ON RECURRING_TAXES (IS_ACTIVE);
CREATE INDEX IDX_RECURRING_TAXES_PAYMENT_DAY ON RECURRING_TAXES (PAYMENT_DAY);

-- PURCHASE_INVOICES definition
-- Drop table
-- DROP TABLE PURCHASE_INVOICES;
-- NOVA TABELA: Gestão de Compras e Entrada de Estoque (Fase 2 - Ajustes Lógicos)

CREATE TABLE PURCHASE_INVOICES (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	INVOICE_NUMBER VARCHAR(50) NOT NULL,
	SUPPLIER_NAME VARCHAR(255) NOT NULL,
	TOTAL_AMOUNT DECIMAL(12,2) NOT NULL,
	PURCHASE_DATE TIMESTAMP NOT NULL,
	PAYMENT_STATUS VARCHAR(20) DEFAULT 'Pending' NOT NULL,
	PAYMENT_METHOD VARCHAR(50),
	PAYMENT_DATE TIMESTAMP,
	NOTES BLOB SUB_TYPE TEXT,
	CREATED_BY INTEGER,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	CONSTRAINT PK_PURCHASE_INVOICES PRIMARY KEY (ID),
	CONSTRAINT FK_PURCHASE_INVOICES_USER FOREIGN KEY (CREATED_BY) REFERENCES USERS(ID),
	CONSTRAINT CHK_PURCHASE_INVOICES_STATUS CHECK (PAYMENT_STATUS IN ('Pending', 'Paid')),
	CONSTRAINT CHK_PURCHASE_INVOICES_VALUE CHECK (TOTAL_AMOUNT > 0)
);
CREATE INDEX IDX_PURCHASE_INVOICES_DATE ON PURCHASE_INVOICES (PURCHASE_DATE);
CREATE INDEX IDX_PURCHASE_INVOICES_STATUS ON PURCHASE_INVOICES (PAYMENT_STATUS);
CREATE INDEX IDX_PURCHASE_INVOICES_SUPPLIER ON PURCHASE_INVOICES (SUPPLIER_NAME);

-- PURCHASE_INVOICE_ITEMS definition
-- Drop table
-- DROP TABLE PURCHASE_INVOICE_ITEMS;
-- NOVA TABELA: Itens das Notas Fiscais de Compra (Fase 2 - Ajustes Lógicos)

CREATE TABLE PURCHASE_INVOICE_ITEMS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	PURCHASE_INVOICE_ID INTEGER NOT NULL,
	INGREDIENT_ID INTEGER NOT NULL,
	QUANTITY DECIMAL(10,3) NOT NULL,
	UNIT_PRICE DECIMAL(10,2) NOT NULL,
	TOTAL_PRICE DECIMAL(12,2) NOT NULL,
	CONSTRAINT PK_PURCHASE_INVOICE_ITEMS PRIMARY KEY (ID),
	CONSTRAINT FK_PURCHASE_INVOICE_ITEMS_INVOICE FOREIGN KEY (PURCHASE_INVOICE_ID) REFERENCES PURCHASE_INVOICES(ID) ON DELETE CASCADE,
	CONSTRAINT FK_PURCHASE_INVOICE_ITEMS_INGREDIENT FOREIGN KEY (INGREDIENT_ID) REFERENCES INGREDIENTS(ID),
	CONSTRAINT CHK_PURCHASE_INVOICE_ITEMS_QUANTITY CHECK (QUANTITY > 0),
	CONSTRAINT CHK_PURCHASE_INVOICE_ITEMS_PRICE CHECK (UNIT_PRICE > 0)
);
CREATE INDEX IDX_PURCHASE_INVOICE_ITEMS_INVOICE ON PURCHASE_INVOICE_ITEMS (PURCHASE_INVOICE_ID);
CREATE INDEX IDX_PURCHASE_INVOICE_ITEMS_INGREDIENT ON PURCHASE_INVOICE_ITEMS (INGREDIENT_ID);

-- RECURRENCE_RULES definition
-- Drop table
-- DROP TABLE RECURRENCE_RULES;
-- NOVA TABELA: Regras de Recorrência para Despesas e Impostos (Fase 5 - Ajustes Lógicos)

CREATE TABLE RECURRENCE_RULES (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	DESCRIPTION VARCHAR(255),
	TYPE VARCHAR(20) NOT NULL,
	CATEGORY VARCHAR(100) NOT NULL,
	SUBCATEGORY VARCHAR(100),
	"VALUE" DECIMAL(12,2) NOT NULL,
	RECURRENCE_TYPE VARCHAR(20) NOT NULL,
	RECURRENCE_DAY INTEGER,
	SENDER_RECEIVER VARCHAR(255),
	IS_ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	NOTES BLOB SUB_TYPE TEXT,
	CREATED_BY INTEGER,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	CONSTRAINT PK_RECURRENCE_RULES PRIMARY KEY (ID),
	CONSTRAINT FK_RECURRENCE_RULES_USER FOREIGN KEY (CREATED_BY) REFERENCES USERS(ID),
	CONSTRAINT CHK_RECURRENCE_RULES_TYPE CHECK (TYPE IN ('EXPENSE', 'TAX')),
	CONSTRAINT CHK_RECURRENCE_RULES_RECURRENCE CHECK (RECURRENCE_TYPE IN ('MONTHLY', 'WEEKLY', 'YEARLY')),
	CONSTRAINT CHK_RECURRENCE_RULES_VALUE CHECK ("VALUE" > 0)
);
CREATE INDEX IDX_RECURRENCE_RULES_ACTIVE ON RECURRENCE_RULES (IS_ACTIVE);
CREATE INDEX IDX_RECURRENCE_RULES_TYPE ON RECURRENCE_RULES (RECURRENCE_TYPE, RECURRENCE_DAY);

-- INGREDIENTS definition
-- Drop table
-- DROP TABLE INGREDIENTS;

CREATE TABLE INGREDIENTS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	PRICE DECIMAL(10,2) DEFAULT 0 NOT NULL,
    ADDITIONAL_PRICE DECIMAL(10,2) DEFAULT 0 NOT NULL,
	IS_AVAILABLE BOOLEAN DEFAULT TRUE NOT NULL,
	CURRENT_STOCK DECIMAL(10,3) DEFAULT 0 NOT NULL,
	STOCK_UNIT VARCHAR(10) DEFAULT 'un' NOT NULL,
	MIN_STOCK_THRESHOLD DECIMAL(10,3) DEFAULT 0 NOT NULL,
	MAX_STOCK DECIMAL(10,3) DEFAULT 0 NOT NULL,
	SUPPLIER VARCHAR(255),
	CATEGORY VARCHAR(100),
	STOCK_STATUS VARCHAR(20) DEFAULT 'ok',
	-- Campos para sistema de porções padronizadas
	BASE_PORTION_QUANTITY DECIMAL(10,3) DEFAULT 1 NOT NULL,
	BASE_PORTION_UNIT VARCHAR(10) DEFAULT 'un' NOT NULL,
	CONSTRAINT INTEG_42 PRIMARY KEY (ID),
	CONSTRAINT INTEG_44 UNIQUE (NAME)
);
CREATE UNIQUE INDEX "RDB$18" ON INGREDIENTS (NAME);
CREATE UNIQUE INDEX RDB$PRIMARY17 ON INGREDIENTS (ID);

-- LOYALTY_POINTS definition
-- Drop table
-- DROP TABLE LOYALTY_POINTS;

CREATE TABLE LOYALTY_POINTS (
	USER_ID INTEGER NOT NULL,
	ACCUMULATED_POINTS INTEGER DEFAULT 0 NOT NULL,
	SPENT_POINTS INTEGER DEFAULT 0 NOT NULL,
	POINTS_EXPIRATION_DATE DATE,
	CONSTRAINT INTEG_77 PRIMARY KEY (USER_ID),
	CONSTRAINT INTEG_78 FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);
CREATE INDEX RDB$FOREIGN33 ON LOYALTY_POINTS (USER_ID);
CREATE UNIQUE INDEX RDB$PRIMARY32 ON LOYALTY_POINTS (USER_ID);

-- LOYALTY_POINTS_HISTORY definition
-- Drop table
-- DROP TABLE LOYALTY_POINTS_HISTORY;

CREATE TABLE LOYALTY_POINTS_HISTORY (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	USER_ID INTEGER NOT NULL,
	ORDER_ID INTEGER,
	POINTS INTEGER NOT NULL,
	REASON VARCHAR(255),
	EARNED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	CONSTRAINT INTEG_81 PRIMARY KEY (ID),
	CONSTRAINT INTEG_83 FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);
CREATE INDEX RDB$FOREIGN35 ON LOYALTY_POINTS_HISTORY (USER_ID);
CREATE UNIQUE INDEX RDB$PRIMARY34 ON LOYALTY_POINTS_HISTORY (ID);

-- NOTIFICATIONS definition
-- Drop table
-- DROP TABLE NOTIFICATIONS;

CREATE TABLE NOTIFICATIONS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	USER_ID INTEGER NOT NULL,
	MESSAGE VARCHAR(512) NOT NULL,
	LINK VARCHAR(255),
	IS_READ BOOLEAN DEFAULT FALSE NOT NULL,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	CONSTRAINT INTEG_101 PRIMARY KEY (ID),
	CONSTRAINT INTEG_103 FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);
CREATE INDEX RDB$FOREIGN45 ON NOTIFICATIONS (USER_ID);
CREATE UNIQUE INDEX RDB$PRIMARY44 ON NOTIFICATIONS (ID);

-- ORDER_ITEM_EXTRAS definition
-- Drop table
-- DROP TABLE ORDER_ITEM_EXTRAS;

CREATE TABLE ORDER_ITEM_EXTRAS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	ORDER_ITEM_ID INTEGER NOT NULL,
	INGREDIENT_ID INTEGER NOT NULL,
	QUANTITY INTEGER DEFAULT 1 NOT NULL,
	TYPE VARCHAR(10) DEFAULT 'extra' NOT NULL,
	DELTA INTEGER DEFAULT 1 NOT NULL,
	UNIT_PRICE DECIMAL(10,2) DEFAULT 0 NOT NULL,
	CONSTRAINT INTEG_69 PRIMARY KEY (ID),
	CONSTRAINT INTEG_71 FOREIGN KEY (ORDER_ITEM_ID) REFERENCES ORDER_ITEMS(ID) ON DELETE CASCADE,
	CONSTRAINT INTEG_73 FOREIGN KEY (INGREDIENT_ID) REFERENCES INGREDIENTS(ID)
);
CREATE INDEX RDB$FOREIGN30 ON ORDER_ITEM_EXTRAS (ORDER_ITEM_ID);
CREATE INDEX RDB$FOREIGN31 ON ORDER_ITEM_EXTRAS (INGREDIENT_ID);
CREATE INDEX IDX_ORDER_ITEM_EXTRAS_TYPE ON ORDER_ITEM_EXTRAS (TYPE);
CREATE UNIQUE INDEX UQ_ORDER_ITEM_ING_TYPE ON ORDER_ITEM_EXTRAS (ORDER_ITEM_ID, INGREDIENT_ID, TYPE);
CREATE UNIQUE INDEX RDB$PRIMARY29 ON ORDER_ITEM_EXTRAS (ID);

-- ORDER_ITEMS definition
-- Drop table
-- DROP TABLE ORDER_ITEMS;

CREATE TABLE ORDER_ITEMS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	ORDER_ID INTEGER NOT NULL,
	PRODUCT_ID INTEGER NOT NULL,
	QUANTITY INTEGER NOT NULL,
	UNIT_PRICE DECIMAL(10,2) NOT NULL,
	NOTES BLOB SUB_TYPE TEXT,
	CONSTRAINT INTEG_62 PRIMARY KEY (ID),
	CONSTRAINT INTEG_64 FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ID) ON DELETE CASCADE,
	CONSTRAINT INTEG_66 FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCTS(ID)
);
CREATE INDEX RDB$FOREIGN27 ON ORDER_ITEMS (ORDER_ID);
CREATE INDEX RDB$FOREIGN28 ON ORDER_ITEMS (PRODUCT_ID);
CREATE UNIQUE INDEX RDB$PRIMARY26 ON ORDER_ITEMS (ID);

-- ORDERS definition
-- Drop table
-- DROP TABLE ORDERS;

CREATE TABLE ORDERS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	USER_ID INTEGER,
	ADDRESS_ID INTEGER,
	STATUS VARCHAR(20) NOT NULL,
	TOTAL_AMOUNT DECIMAL(10,2) DEFAULT 0 NOT NULL,
	PAYMENT_METHOD VARCHAR(20),
	NOTES BLOB SUB_TYPE TEXT,
	CONFIRMATION_CODE VARCHAR(10),
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	UPDATED_AT TIMESTAMP,
	ORDER_TYPE VARCHAR(20) DEFAULT 'delivery' NOT NULL,
	TABLE_ID INTEGER,
	ATTENDANT_ID INTEGER,
	DELIVERER_ID INTEGER,
	CONSTRAINT INTEG_53 PRIMARY KEY (ID),
	CONSTRAINT FK_ORDERS_DELIVERER FOREIGN KEY (DELIVERER_ID) REFERENCES USERS(ID),
	CONSTRAINT INTEG_54 FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
	CONSTRAINT INTEG_55 FOREIGN KEY (ADDRESS_ID) REFERENCES ADDRESSES(ID),
	CONSTRAINT INTEG_61 FOREIGN KEY (ATTENDANT_ID) REFERENCES USERS(ID)
);
CREATE INDEX FK_ORDERS_DELIVERER ON ORDERS (DELIVERER_ID);
CREATE INDEX IX_ORDERS_DELIVERER ON ORDERS (DELIVERER_ID);
CREATE INDEX RDB$FOREIGN23 ON ORDERS (USER_ID);
CREATE INDEX RDB$FOREIGN24 ON ORDERS (ADDRESS_ID);
CREATE INDEX RDB$FOREIGN25 ON ORDERS (ATTENDANT_ID);
CREATE UNIQUE INDEX RDB$PRIMARY22 ON ORDERS (ID);

-- PASSWORD_RESET definition
-- Drop table
-- DROP TABLE PASSWORD_RESET;

CREATE TABLE PASSWORD_RESET (
	USER_ID INTEGER NOT NULL,
	VERIFICATION_CODE VARCHAR(6) NOT NULL,
	EXPIRES_AT TIMESTAMP NOT NULL,
	USED_AT TIMESTAMP
);
CREATE INDEX IDX_PASSWORD_RESET_USER ON PASSWORD_RESET (USER_ID);
CREATE UNIQUE INDEX UQ_PASSWORD_RESET_CODE ON PASSWORD_RESET (VERIFICATION_CODE);

-- PRODUCT_INGREDIENTS definition
-- Drop table
-- DROP TABLE PRODUCT_INGREDIENTS;

CREATE TABLE PRODUCT_INGREDIENTS (
	PRODUCT_ID INTEGER NOT NULL,
	INGREDIENT_ID INTEGER NOT NULL,
	PORTIONS DECIMAL(10,2) DEFAULT 0 NOT NULL,
	MIN_QUANTITY INTEGER DEFAULT 0,
	MAX_QUANTITY INTEGER DEFAULT 0,
	CONSTRAINT PK_PRODUCT_INGREDIENTS PRIMARY KEY (PRODUCT_ID, INGREDIENT_ID),
	CONSTRAINT FK_PRODUCT_INGREDIENTS_PRODUCT FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCTS(ID) ON DELETE CASCADE,
	CONSTRAINT FK_PRODUCT_INGREDIENTS_INGREDIENT FOREIGN KEY (INGREDIENT_ID) REFERENCES INGREDIENTS(ID) ON DELETE CASCADE
);
CREATE INDEX IDX_PRODUCT_INGREDIENTS_PRODUCT_ID ON PRODUCT_INGREDIENTS (PRODUCT_ID);
CREATE INDEX IDX_PRODUCT_INGREDIENTS_INGREDIENT_ID ON PRODUCT_INGREDIENTS (INGREDIENT_ID);

-- PRODUCTS definition
-- Drop table
-- DROP TABLE PRODUCTS;

-- GROUPS_EXTRAS definition
-- Drop table
-- DROP TABLE GROUPS_EXTRAS;

CREATE TABLE GROUPS_EXTRAS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	IS_ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	CONSTRAINT PK_GROUPS_EXTRAS PRIMARY KEY (ID)
);
CREATE INDEX IDX_GROUPS_EXTRAS_NAME ON GROUPS_EXTRAS (NAME);
CREATE INDEX IDX_GROUPS_EXTRAS_ACTIVE ON GROUPS_EXTRAS (IS_ACTIVE);

-- GROUP_INGREDIENTS_EXTRAS definition
-- Drop table
-- DROP TABLE GROUP_INGREDIENTS_EXTRAS;

CREATE TABLE GROUP_INGREDIENTS_EXTRAS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	GROUP_ID INTEGER NOT NULL,
	INGREDIENT_ID INTEGER NOT NULL,
	CONSTRAINT PK_GROUP_INGREDIENTS_EXTRAS PRIMARY KEY (ID),
	CONSTRAINT FK_GROUP_INGREDIENTS_GROUP FOREIGN KEY (GROUP_ID) REFERENCES GROUPS_EXTRAS(ID) ON DELETE CASCADE,
	CONSTRAINT FK_GROUP_INGREDIENTS_ING FOREIGN KEY (INGREDIENT_ID) REFERENCES INGREDIENTS(ID) ON DELETE CASCADE,
	CONSTRAINT UQ_GROUP_INGREDIENT UNIQUE (GROUP_ID, INGREDIENT_ID)
);
CREATE INDEX IDX_GIE_GROUP ON GROUP_INGREDIENTS_EXTRAS (GROUP_ID);
CREATE INDEX IDX_GIE_INGREDIENT ON GROUP_INGREDIENTS_EXTRAS (INGREDIENT_ID);

CREATE TABLE PRODUCTS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	DESCRIPTION BLOB SUB_TYPE TEXT,
	PRICE DECIMAL(10,2) NOT NULL,
	IMAGE_URL VARCHAR(512),
	IS_ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	COST_PRICE DECIMAL(10,2) DEFAULT 0 NOT NULL,
	PREPARATION_TIME_MINUTES INTEGER DEFAULT 0 NOT NULL,
	CATEGORY_ID INTEGER,
	CONSTRAINT INTEG_37 PRIMARY KEY (ID),
	CONSTRAINT FK_PRODUCTS_CATEGORY FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORIES(ID)
);
CREATE INDEX FK_PRODUCTS_CATEGORY ON PRODUCTS (CATEGORY_ID);
CREATE INDEX IDX_PRODUCTS_CATEGORY_ID ON PRODUCTS (CATEGORY_ID);
CREATE UNIQUE INDEX RDB$PRIMARY15 ON PRODUCTS (ID);

-- TOKEN_BLACKLIST definition
-- Drop table
-- DROP TABLE TOKEN_BLACKLIST;

CREATE TABLE TOKEN_BLACKLIST (
	JTI VARCHAR(36) NOT NULL,
	EXPIRES_AT TIMESTAMP NOT NULL,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	CONSTRAINT INTEG_108 PRIMARY KEY (JTI)
);
CREATE UNIQUE INDEX RDB$PRIMARY46 ON TOKEN_BLACKLIST (JTI);

-- TWO_FACTOR_VERIFICATIONS definition
-- Drop table
-- DROP TABLE TWO_FACTOR_VERIFICATIONS;

CREATE TABLE TWO_FACTOR_VERIFICATIONS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	USER_ID INTEGER NOT NULL,
	VERIFICATION_CODE VARCHAR(6) NOT NULL,
	EXPIRES_AT TIMESTAMP NOT NULL,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	USED BOOLEAN DEFAULT FALSE,
	CONSTRAINT INTEG_131 PRIMARY KEY (ID),
	CONSTRAINT INTEG_135 FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);
CREATE INDEX IDX_TWO_FACTOR_EXPIRES ON TWO_FACTOR_VERIFICATIONS (EXPIRES_AT);
CREATE INDEX IDX_TWO_FACTOR_USER_ID ON TWO_FACTOR_VERIFICATIONS (USER_ID);
CREATE INDEX RDB$FOREIGN53 ON TWO_FACTOR_VERIFICATIONS (USER_ID);
CREATE UNIQUE INDEX RDB$PRIMARY52 ON TWO_FACTOR_VERIFICATIONS (ID);

-- USERS definition
-- Drop table
-- DROP TABLE USERS;

CREATE TABLE USERS (
	ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
	FULL_NAME VARCHAR(100) NOT NULL,
	EMAIL VARCHAR(100) NOT NULL,
	PASSWORD_HASH VARCHAR(255) NOT NULL,
	"ROLE" VARCHAR(20) NOT NULL,
	PHONE VARCHAR(20),
	CPF VARCHAR(14),
	DATE_OF_BIRTH DATE NOT NULL,
	IS_ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	IS_EMAIL_VERIFIED BOOLEAN DEFAULT FALSE,
	TWO_FACTOR_ENABLED BOOLEAN DEFAULT FALSE,
	NOTIFY_ORDER_UPDATES BOOLEAN DEFAULT TRUE,
	NOTIFY_PROMOTIONS BOOLEAN DEFAULT TRUE,
	CONSTRAINT INTEG_12 UNIQUE (CPF),
	CONSTRAINT INTEG_4 PRIMARY KEY (ID)
);
CREATE UNIQUE INDEX "RDB$6" ON USERS (CPF);
CREATE UNIQUE INDEX RDB$PRIMARY3 ON USERS (ID);
CREATE INDEX IDX_USERS_NOTIFY_ORDER_UPDATES ON USERS (NOTIFY_ORDER_UPDATES);
CREATE INDEX IDX_USERS_NOTIFY_PROMOTIONS ON USERS (NOTIFY_PROMOTIONS);

-- STORE_HOURS definition
-- Drop table
-- DROP TABLE STORE_HOURS;

CREATE TABLE STORE_HOURS (
	DAY_OF_WEEK INTEGER NOT NULL,
	OPENING_TIME TIME,
	CLOSING_TIME TIME,
	IS_OPEN BOOLEAN DEFAULT TRUE NOT NULL,
	CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	CONSTRAINT PK_STORE_HOURS PRIMARY KEY (DAY_OF_WEEK),
	CONSTRAINT CHK_STORE_HOURS_DAY CHECK (DAY_OF_WEEK >= 0 AND DAY_OF_WEEK <= 6)
);
CREATE INDEX IDX_STORE_HOURS_DAY ON STORE_HOURS (DAY_OF_WEEK);
CREATE INDEX IDX_STORE_HOURS_OPEN ON STORE_HOURS (IS_OPEN);

-- RESTAURANT_TABLES definition
-- Drop table
-- DROP TABLE RESTAURANT_TABLES;

CREATE TABLE RESTAURANT_TABLES (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    NAME VARCHAR(100) NOT NULL,
    STATUS VARCHAR(20) DEFAULT 'available' NOT NULL,
    CURRENT_ORDER_ID INTEGER,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PK_RESTAURANT_TABLES PRIMARY KEY (ID),
    CONSTRAINT FK_RESTAURANT_TABLES_ORDER FOREIGN KEY (CURRENT_ORDER_ID) REFERENCES ORDERS(ID) ON DELETE SET NULL,
    CONSTRAINT CHK_TABLE_STATUS CHECK (STATUS IN ('available', 'occupied', 'cleaning', 'reserved')),
    CONSTRAINT UK_TABLE_NAME UNIQUE(NAME)
);
CREATE INDEX IDX_RESTAURANT_TABLES_STATUS ON RESTAURANT_TABLES (STATUS);
CREATE INDEX IDX_RESTAURANT_TABLES_CURRENT_ORDER ON RESTAURANT_TABLES (CURRENT_ORDER_ID);

-- TEMPORARY_RESERVATIONS definition
-- Drop table
-- DROP TABLE TEMPORARY_RESERVATIONS;

CREATE TABLE TEMPORARY_RESERVATIONS (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    INGREDIENT_ID INTEGER NOT NULL,
    QUANTITY DECIMAL(12,3) NOT NULL,
    SESSION_ID VARCHAR(255),
    USER_ID INTEGER,
    CART_ID INTEGER,
    EXPIRES_AT TIMESTAMP NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_TEMPORARY_RESERVATIONS PRIMARY KEY (ID),
    CONSTRAINT FK_TEMPORARY_RESERVATIONS_INGREDIENT FOREIGN KEY (INGREDIENT_ID) REFERENCES INGREDIENTS(ID) ON DELETE CASCADE,
    CONSTRAINT FK_TEMPORARY_RESERVATIONS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    CONSTRAINT FK_TEMPORARY_RESERVATIONS_CART FOREIGN KEY (CART_ID) REFERENCES CARTS(ID) ON DELETE CASCADE
);
CREATE INDEX IDX_TEMPORARY_RESERVATIONS_INGREDIENT ON TEMPORARY_RESERVATIONS (INGREDIENT_ID);
CREATE INDEX IDX_TEMPORARY_RESERVATIONS_CART ON TEMPORARY_RESERVATIONS (CART_ID);
CREATE INDEX IDX_TEMPORARY_RESERVATIONS_USER ON TEMPORARY_RESERVATIONS (USER_ID);
CREATE INDEX IDX_TEMPORARY_RESERVATIONS_SESSION ON TEMPORARY_RESERVATIONS (SESSION_ID);
CREATE INDEX IDX_TEMPORARY_RESERVATIONS_EXPIRES ON TEMPORARY_RESERVATIONS (EXPIRES_AT);
CREATE INDEX IDX_TEMPORARY_RESERVATIONS_INGREDIENT_EXPIRES ON TEMPORARY_RESERVATIONS (INGREDIENT_ID, EXPIRES_AT);

-- USER_DEVICES definition
-- Drop table
-- DROP TABLE USER_DEVICES;
-- NOVA TABELA: Dispositivos para Push Notifications (Expo)

CREATE TABLE USER_DEVICES (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    USER_ID INTEGER NOT NULL,
    PUSH_TOKEN VARCHAR(255) NOT NULL,
    DEVICE_NAME VARCHAR(100),
    LAST_USED TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT PK_USER_DEVICES PRIMARY KEY (ID),
    CONSTRAINT FK_USER_DEVICES_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
    CONSTRAINT UQ_USER_DEVICES_TOKEN UNIQUE (PUSH_TOKEN)
);
CREATE INDEX IDX_USER_DEVICES_USER_ID ON USER_DEVICES (USER_ID);
CREATE INDEX IDX_USER_DEVICES_PUSH_TOKEN ON USER_DEVICES (PUSH_TOKEN);
CREATE INDEX IDX_USER_DEVICES_LAST_USED ON USER_DEVICES (LAST_USED);

-- =====================================================
-- COMENTÁRIOS SOBRE AS TABELAS
-- =====================================================

/*
TABELAS PRINCIPAIS:
- USERS: Usuários do sistema (clientes, funcionários, administradores)
- CATEGORIES: Categorias de produtos
- PRODUCTS: Produtos do cardápio
- INGREDIENTS: Ingredientes dos produtos
- ORDERS: Pedidos realizados
- ADDRESSES: Endereços dos usuários

TABELAS DE RELACIONAMENTO:
- PRODUCT_INGREDIENTS: Relaciona produtos com seus ingredientes
- ORDER_ITEMS: Itens de um pedido
- ORDER_ITEM_EXTRAS: Extras adicionais nos itens do pedido
- CART_ITEMS: Itens no carrinho de compras
- CART_ITEM_EXTRAS: Extras no carrinho

TABELAS DE FUNCIONALIDADES:
- EMAIL_VERIFICATIONS: Códigos de verificação de email
- PASSWORD_RESET: Códigos de reset de senha
- TWO_FACTOR_VERIFICATIONS: Códigos de autenticação de dois fatores
- TOKEN_BLACKLIST: Tokens JWT revogados
- LOYALTY_POINTS: Sistema de pontos de fidelidade
- FINANCIAL_TRANSACTIONS: Transações financeiras (legado - mantido para histórico)
- FINANCIAL_MOVEMENTS: Movimentações financeiras (novo sistema de fluxo de caixa)
- RECURRING_TAXES: Impostos recorrentes (gestão de despesas fixas)
- PURCHASE_INVOICES: Notas fiscais de compra de ingredientes (Fase 2 - Ajustes Lógicos)
- PURCHASE_INVOICE_ITEMS: Itens das notas fiscais de compra (Fase 2 - Ajustes Lógicos)
- RECURRENCE_RULES: Regras de recorrência para despesas e impostos (Fase 5 - Ajustes Lógicos)
- NOTIFICATIONS: Notificações do sistema
- CHATS: Sistema de chat para pedidos
- APP_SETTINGS: Configurações da aplicação
- STORE_HOURS: Horários de funcionamento da loja
- RESTAURANT_TABLES: Mesas do restaurante (gestão de salão)
- TEMPORARY_RESERVATIONS: Reservas temporárias de insumos (soft locks) para carrinho
- USER_DEVICES: Dispositivos dos usuários para Push Notifications (Expo)

CAMPOS DE PREFERÊNCIAS DE NOTIFICAÇÃO (USERS):
- NOTIFY_ORDER_UPDATES: Receber notificações sobre atualizações de pedidos (padrão: TRUE)
- NOTIFY_PROMOTIONS: Receber notificações sobre promoções e novidades (padrão: TRUE)

FUNCIONALIDADES IMPLEMENTADAS:
- Sistema de autenticação com JWT
- Verificação de email
- Reset de senha
- Autenticação de dois fatores
- Sistema de carrinho
- Gestão de estoque de ingredientes
- Sistema de pedidos
- Chat em tempo real
- Pontos de fidelidade
- Gestão financeira (sistema legado: FINANCIAL_TRANSACTIONS)
- Sistema de Fluxo de Caixa Remodelado (FINANCIAL_MOVEMENTS)
- Gestão de Impostos Recorrentes (RECURRING_TAXES)
- Gestão de Compras e Entrada de Estoque (PURCHASE_INVOICES, PURCHASE_INVOICE_ITEMS)
- Regras de Recorrência Genéricas (RECURRENCE_RULES)
- Integração com Gateways de Pagamento (campos em FINANCIAL_MOVEMENTS)
- Conciliação Bancária (campos RECONCILED, RECONCILED_AT em FINANCIAL_MOVEMENTS)
- Taxas de Métodos de Pagamento (campos em APP_SETTINGS)
- Notificações
- Preferências de notificação personalizadas por usuário
- Ordenação de categorias (DISPLAY_ORDER)
- Horários de funcionamento da loja
- Gestão de salão (mesas e atendentes) - pedidos on-site
- Reservas temporárias de insumos (soft locks) para evitar conflitos de estoque
- Limites de quantidade por cliente para promoções
*/

-- =====================================================
-- DADOS INICIAIS - HORÁRIOS DE FUNCIONAMENTO
-- =====================================================

-- Inserir horários padrão da loja (segunda a domingo)
-- 0 = Domingo, 1 = Segunda, 2 = Terça, 3 = Quarta, 4 = Quinta, 5 = Sexta, 6 = Sábado

INSERT INTO STORE_HOURS (DAY_OF_WEEK, OPENING_TIME, CLOSING_TIME, IS_OPEN) VALUES
(0, '10:00:00', '22:00:00', TRUE),  -- Domingo
(1, '10:00:00', '22:00:00', TRUE),  -- Segunda
(2, '10:00:00', '22:00:00', TRUE),  -- Terça
(3, '10:00:00', '22:00:00', TRUE),  -- Quarta
(4, '10:00:00', '22:00:00', TRUE),  -- Quinta
(5, '10:00:00', '23:00:00', TRUE),  -- Sexta
(6, '10:00:00', '23:00:00', TRUE);  -- Sábado

-- =====================================================
-- COMENTÁRIOS SOBRE OS DADOS INICIAIS
-- =====================================================

/*
HORÁRIOS PADRÃO:
- Segunda a Quinta: 10:00 às 22:00
- Sexta e Sábado: 10:00 às 23:00  
- Domingo: 10:00 às 22:00

Para modificar os horários, use:
UPDATE STORE_HOURS SET OPENING_TIME = '09:00:00', CLOSING_TIME = '23:00:00' WHERE DAY_OF_WEEK = 1;

Para fechar a loja em um dia específico:
UPDATE STORE_HOURS SET IS_OPEN = FALSE WHERE DAY_OF_WEEK = 0; -- Fechar domingo
*/
